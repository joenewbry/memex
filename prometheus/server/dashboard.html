<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Memex Prometheus</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', 'JetBrains Mono', monospace;
    background: #08080d;
    color: #c8c8d0;
    min-height: 100vh;
  }
  .container { max-width: 1100px; margin: 0 auto; padding: 32px 24px; }

  /* Header */
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
  }
  .logo { font-size: 22px; font-weight: 700; color: #e8e8f0; letter-spacing: -0.5px; }
  .logo span { color: #6366f1; }
  .header-right { display: flex; align-items: center; gap: 16px; }
  .status-pill {
    font-size: 11px; padding: 4px 12px; border-radius: 100px;
    background: #0a2818; color: #4ade80; border: 1px solid #166534; font-weight: 500;
  }
  .status-pill.offline { background: #280a0a; color: #f87171; border-color: #991b1b; }
  .refresh-text { font-size: 11px; color: #444460; }

  /* Instance Grid */
  .instance-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 48px;
  }
  .instance-card {
    background: #0e0e18;
    border: 1px solid #1a1a2e;
    border-radius: 16px;
    padding: 28px;
    cursor: pointer;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
    min-height: 280px;
    display: flex;
    flex-direction: column;
  }
  .instance-card:hover {
    border-color: #2a2a50;
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
  }
  .instance-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 3px;
    border-radius: 16px 16px 0 0;
  }
  .instance-card[data-color="indigo"]::before { background: linear-gradient(90deg, #6366f1, #818cf8); }
  .instance-card[data-color="emerald"]::before { background: linear-gradient(90deg, #10b981, #34d399); }
  .instance-card[data-color="amber"]::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
  .instance-card[data-color="rose"]::before { background: linear-gradient(90deg, #f43f5e, #fb7185); }

  .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .card-name { font-size: 18px; font-weight: 700; color: #e8e8f0; }
  .card-status {
    width: 10px; height: 10px; border-radius: 50%;
    background: #4ade80; box-shadow: 0 0 8px #4ade8066;
  }
  .card-status.stale { background: #fbbf24; box-shadow: 0 0 8px #fbbf2466; }
  .card-status.inactive { background: #525268; box-shadow: none; }

  .card-metric { margin-bottom: 16px; }
  .card-metric-value { font-size: 32px; font-weight: 700; color: #e8e8f0; line-height: 1.1; }
  .card-metric-label { font-size: 11px; color: #5a5a78; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

  .card-stats { display: flex; gap: 24px; margin-bottom: 16px; }
  .card-stat-value { font-size: 16px; font-weight: 600; color: #b0b0c0; }
  .card-stat-label { font-size: 10px; color: #5a5a78; text-transform: uppercase; letter-spacing: 0.5px; }

  .card-sparkline { flex: 1; display: flex; align-items: flex-end; }
  .card-sparkline svg { width: 100%; }

  .card-arrow {
    position: absolute; bottom: 20px; right: 24px;
    font-size: 14px; color: #3a3a54;
    transition: color 0.2s, transform 0.2s;
  }
  .instance-card:hover .card-arrow { color: #6366f1; transform: translateX(4px); }

  /* Detail View */
  #detail-view { display: none; }
  .back-link {
    display: inline-flex; align-items: center; gap: 8px;
    font-size: 13px; color: #6366f1; cursor: pointer;
    margin-bottom: 24px; transition: color 0.2s;
  }
  .back-link:hover { color: #818cf8; }

  .detail-header {
    display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;
  }
  .detail-name { font-size: 28px; font-weight: 700; color: #e8e8f0; }

  .stats-row {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 40px;
  }
  .stat-card {
    background: #0e0e18; border: 1px solid #1a1a2e; border-radius: 12px;
    padding: 20px; text-align: center;
  }
  .stat-card-value { font-size: 28px; font-weight: 700; color: #e8e8f0; }
  .stat-card-label {
    font-size: 11px; color: #5a5a78; text-transform: uppercase;
    letter-spacing: 0.5px; margin-top: 4px;
  }

  /* Sections */
  .section { margin-bottom: 40px; }
  .section-title {
    font-size: 12px; font-weight: 600; color: #6a6a88;
    text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px;
  }

  /* Bar Chart */
  .chart-container {
    background: #0e0e18; border: 1px solid #1a1a2e; border-radius: 12px; padding: 24px;
  }
  .chart-bars {
    display: flex; align-items: flex-end; gap: 3px; height: 160px; padding-top: 8px;
  }
  .chart-bar-wrapper {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; height: 100%; justify-content: flex-end;
  }
  .chart-bar {
    width: 100%; max-width: 24px; border-radius: 3px 3px 0 0;
    min-height: 2px; transition: opacity 0.2s; cursor: default;
  }
  .chart-bar:hover { opacity: 0.8; }
  .chart-label {
    font-size: 9px; color: #3a3a54; margin-top: 6px;
    transform: rotate(-45deg); white-space: nowrap;
  }
  .chart-tooltip {
    font-size: 10px; color: #8888a0; margin-bottom: 4px; white-space: nowrap;
  }

  /* Tool breakdown */
  .tool-row { display: flex; align-items: center; margin-bottom: 8px; }
  .tool-name {
    font-size: 12px; color: #8888a0; width: 200px;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .tool-bar-bg {
    flex: 1; height: 8px; background: #14141e; border-radius: 4px;
    margin: 0 12px; overflow: hidden;
  }
  .tool-bar-fill { height: 100%; border-radius: 4px; min-width: 4px; transition: width 0.3s ease; }
  .tool-count { font-size: 12px; color: #5a5a78; width: 50px; text-align: right; font-weight: 600; }

  /* Data info grid */
  .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .data-item {
    background: #0e0e18; border: 1px solid #1a1a2e; border-radius: 10px; padding: 16px;
  }
  .data-item-label { font-size: 10px; color: #5a5a78; text-transform: uppercase; letter-spacing: 0.5px; }
  .data-item-value { font-size: 16px; font-weight: 600; color: #b0b0c0; margin-top: 4px; }

  /* Trend badge */
  .trend-badge {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: 500;
  }
  .trend-badge.up { background: #0a2818; color: #4ade80; }
  .trend-badge.down { background: #280a0a; color: #f87171; }
  .trend-badge.flat { background: #1a1a2e; color: #8888a0; }

  /* Footer */
  footer {
    margin-top: 48px; padding-top: 16px; border-top: 1px solid #141420;
    font-size: 11px; color: #2a2a40;
    display: flex; flex-direction: column; gap: 12px;
  }
  .footer-row {
    display: flex; justify-content: space-between; align-items: center;
  }
  .status-legend {
    display: flex; gap: 16px; align-items: center;
  }
  .status-legend-item {
    display: flex; align-items: center; gap: 5px;
  }
  .status-legend-dot {
    width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  }
  .status-legend-dot.active { background: #4ade80; box-shadow: 0 0 6px #4ade8044; }
  .status-legend-dot.stale { background: #fbbf24; box-shadow: 0 0 6px #fbbf2444; }
  .status-legend-dot.inactive { background: #525268; }

  /* Error banner */
  #error-banner {
    display: none; background: #1c0a0a; border: 1px solid #4a1515;
    color: #f87171; padding: 12px 16px; border-radius: 10px;
    margin-bottom: 24px; font-size: 12px;
  }

  /* Loading */
  .loading-skeleton {
    background: linear-gradient(90deg, #0e0e18 25%, #14141e 50%, #0e0e18 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 8px;
  }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  /* Chat Drawer */
  .chat-btn {
    padding: 6px 14px; border-radius: 8px; border: 1px solid #2a2a50;
    background: #14141e; color: #8888a0; cursor: pointer; font-family: inherit;
    font-size: 12px; font-weight: 500; transition: all 0.2s;
  }
  .chat-btn:hover { border-color: #6366f1; color: #c8c8d0; }

  #chat-overlay {
    display: none; position: fixed; top: 0; right: 0; bottom: 0;
    width: 440px; max-width: 100vw; background: #0a0a14;
    border-left: 1px solid #1a1a2e; z-index: 1000;
    flex-direction: column; animation: slideIn 0.2s ease;
  }
  #chat-overlay.open { display: flex; }
  @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

  .chat-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 16px 20px; border-bottom: 1px solid #1a1a2e; flex-shrink: 0;
  }
  .chat-header-title { font-size: 14px; font-weight: 600; color: #e8e8f0; }
  .chat-close {
    background: none; border: none; color: #5a5a78; cursor: pointer;
    font-size: 18px; padding: 4px 8px; border-radius: 6px;
  }
  .chat-close:hover { color: #e8e8f0; background: #1a1a2e; }

  .chat-messages {
    flex: 1; overflow-y: auto; padding: 16px 20px;
    display: flex; flex-direction: column; gap: 12px;
  }
  .chat-msg { max-width: 90%; padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.6; }
  .chat-msg.user {
    align-self: flex-end; background: #1e1e3a; color: #c8c8d0;
    border-bottom-right-radius: 4px;
  }
  .chat-msg.assistant {
    align-self: flex-start; background: #141420; color: #c8c8d0;
    border-bottom-left-radius: 4px; max-width: 95%;
  }
  .chat-msg.assistant p { margin: 0 0 8px; }
  .chat-msg.assistant p:last-child { margin: 0; }
  .chat-msg.assistant code { background: #0a0a14; padding: 1px 5px; border-radius: 3px; font-size: 0.9em; }
  .chat-msg.assistant pre { background: #0a0a14; padding: 10px; border-radius: 6px; overflow-x: auto; margin: 8px 0; }
  .chat-msg.assistant pre code { background: none; padding: 0; }
  .chat-msg.assistant strong { color: #e8e8f0; }
  .chat-msg.assistant ul, .chat-msg.assistant ol { padding-left: 20px; margin: 4px 0; }
  .chat-msg.assistant li { margin: 2px 0; }
  .chat-msg.assistant a { color: #6366f1; }

  .chat-tool-indicator {
    align-self: flex-start; font-size: 11px; color: #5a5a78;
    padding: 4px 10px; background: #0e0e18; border-radius: 6px;
    border: 1px solid #1a1a2e; cursor: pointer;
  }
  .chat-tool-indicator:hover { color: #8888a0; }
  .chat-tool-detail { display: none; font-size: 10px; color: #3a3a54; margin-top: 4px; word-break: break-all; }
  .chat-tool-indicator.expanded .chat-tool-detail { display: block; }

  .chat-page-card {
    align-self: flex-start; background: #0e0e18; border: 1px solid #2a2a50;
    border-radius: 10px; padding: 12px 16px; cursor: pointer;
    transition: border-color 0.2s; max-width: 85%;
  }
  .chat-page-card:hover { border-color: #6366f1; }
  .chat-page-card-title { font-size: 13px; font-weight: 600; color: #e8e8f0; }
  .chat-page-card-url { font-size: 11px; color: #6366f1; margin-top: 2px; }

  .chat-typing {
    align-self: flex-start; padding: 8px 14px;
    font-size: 12px; color: #5a5a78;
  }
  .chat-typing::after {
    content: ''; display: inline-block; width: 4px; height: 14px;
    background: #6366f1; margin-left: 2px; animation: blink 0.8s infinite;
    vertical-align: text-bottom;
  }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

  .chat-input-area {
    display: flex; gap: 8px; padding: 12px 16px;
    border-top: 1px solid #1a1a2e; flex-shrink: 0;
  }
  .chat-input {
    flex: 1; padding: 10px 14px; border-radius: 10px;
    border: 1px solid #1a1a2e; background: #0e0e18; color: #c8c8d0;
    font-family: inherit; font-size: 13px; outline: none; resize: none;
  }
  .chat-input:focus { border-color: #2a2a50; }
  .chat-input::placeholder { color: #3a3a54; }
  .chat-send {
    padding: 10px 16px; border-radius: 10px; border: none;
    background: #6366f1; color: #fff; cursor: pointer; font-family: inherit;
    font-size: 13px; font-weight: 500; transition: background 0.2s;
  }
  .chat-send:hover { background: #818cf8; }
  .chat-send:disabled { background: #2a2a50; color: #5a5a78; cursor: not-allowed; }

  @media (max-width: 700px) {
    .instance-grid { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .data-grid { grid-template-columns: 1fr; }
    .tool-name { width: 120px; }
    .card-stats { gap: 16px; flex-wrap: wrap; }
    #chat-overlay { width: 100vw; }
  }
</style>
</head>
<body>
<div class="container">
  <!-- Main View -->
  <div id="main-view">
    <header>
      <div class="logo">Memex <span>Prometheus</span></div>
      <div class="header-right">
        <button class="chat-btn" onclick="openChat(null, true)">Chat All</button>
        <span class="refresh-text" id="refresh-timer">loading...</span>
        <span class="status-pill" id="server-status">connecting</span>
      </div>
    </header>
    <div id="error-banner"></div>
    <div class="instance-grid" id="instance-grid"></div>
  </div>

  <!-- Detail View -->
  <div id="detail-view">
    <div class="back-link" onclick="showMain()">&#8592; Back to overview</div>
    <div class="detail-header">
      <div class="detail-name" id="detail-name"></div>
      <div style="display:flex;gap:12px;align-items:center;">
        <button class="chat-btn" onclick="openChat(currentInstance, false)">Chat</button>
        <span class="status-pill" id="detail-status">loading</span>
      </div>
    </div>
    <div class="stats-row" id="detail-stats"></div>
    <div class="section">
      <div class="section-title">Usage &#8212; Last 30 Days</div>
      <div class="chart-container">
        <div class="chart-bars" id="usage-chart"></div>
      </div>
    </div>
    <div class="section">
      <div class="section-title">Tool Breakdown</div>
      <div id="tool-breakdown"></div>
    </div>
    <div class="section">
      <div class="section-title">Data</div>
      <div class="data-grid" id="data-info"></div>
    </div>
  </div>

  <footer>
    <div class="footer-row">
      <span>Memex Prometheus <span id="version-text"></span></span>
      <span id="updated-text"></span>
    </div>
    <div class="footer-row">
      <div class="status-legend">
        <div class="status-legend-item"><span class="status-legend-dot active"></span> Active — data received in last hour</div>
        <div class="status-legend-item"><span class="status-legend-dot stale"></span> Stale — no data in 1-24 hours</div>
        <div class="status-legend-item"><span class="status-legend-dot inactive"></span> Inactive — no data in 24+ hours</div>
      </div>
    </div>
  </footer>
</div>

<!-- Chat Overlay -->
<div id="chat-overlay">
  <div class="chat-header">
    <span class="chat-header-title" id="chat-title">Chat</span>
    <button class="chat-close" onclick="closeChat()">&#10005;</button>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-input-area">
    <textarea class="chat-input" id="chat-input" rows="1"
              placeholder="Ask Memex anything..."
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChat();}"></textarea>
    <button class="chat-send" id="chat-send" onclick="sendChat()">Send</button>
  </div>
</div>

<script>
const REFRESH_MS = 30000;
const COLORS = ['indigo', 'emerald', 'amber', 'rose'];
const COLOR_HEX = { indigo: '#6366f1', emerald: '#10b981', amber: '#f59e0b', rose: '#f43f5e' };
const DISPLAY_NAMES = { alaska: 'Alaska Airlines', joe: 'Joe', walmart: 'Walmart', personal: 'Personal' };
function displayName(name) { return DISPLAY_NAMES[name] || name.charAt(0).toUpperCase() + name.slice(1); }
let countdown = REFRESH_MS / 1000;
let timerInterval;
let currentView = 'main';
let currentInstance = null;
let instanceColorMap = {};

function formatBytes(bytes) {
  if (!bytes || bytes === 0) return '0 B';
  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  const val = bytes / Math.pow(1024, i);
  return (i === 0 ? val : val.toFixed(1)) + ' ' + units[i];
}

function formatNumber(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return n.toLocaleString();
}

function timeAgo(iso) {
  if (!iso) return 'never';
  const secs = Math.floor((Date.now() - new Date(iso)) / 1000);
  if (secs < 0) return 'just now';
  if (secs < 60) return secs + 's ago';
  if (secs < 3600) return Math.floor(secs / 60) + 'm ago';
  if (secs < 86400) return Math.floor(secs / 3600) + 'h ago';
  return Math.floor(secs / 86400) + 'd ago';
}

function statusClass(iso) {
  if (!iso) return 'inactive';
  const hrs = (Date.now() - new Date(iso)) / 3600000;
  if (hrs < 1) return '';
  if (hrs < 24) return 'stale';
  return 'inactive';
}

function trendBadge(dailyData) {
  if (!dailyData || dailyData.length < 4) return '<span class="trend-badge flat">no data</span>';
  const half = Math.floor(dailyData.length / 2);
  const firstHalf = dailyData.slice(0, half).reduce((a, b) => a + b, 0);
  const secondHalf = dailyData.slice(half).reduce((a, b) => a + b, 0);
  if (firstHalf === 0 && secondHalf === 0) return '<span class="trend-badge flat">&#8212; no activity</span>';
  if (firstHalf === 0) return '<span class="trend-badge up">&#9650; new</span>';
  const change = ((secondHalf - firstHalf) / firstHalf * 100).toFixed(0);
  if (change > 10) return '<span class="trend-badge up">&#9650; +' + change + '%</span>';
  if (change < -10) return '<span class="trend-badge down">&#9660; ' + change + '%</span>';
  return '<span class="trend-badge flat">&#8212; steady</span>';
}

function sparklineSVG(data, color, w, h) {
  w = w || 240; h = h || 40;
  color = color || '#6366f1';
  if (!data || data.length === 0) return '<svg width="' + w + '" height="' + h + '"></svg>';
  const max = Math.max.apply(null, data.concat([1]));
  const barW = w / data.length;
  let bars = '';
  for (let i = 0; i < data.length; i++) {
    const barH = Math.max((data[i] / max) * h, data[i] > 0 ? 2 : 0);
    bars += '<rect x="' + (i * barW + 1) + '" y="' + (h - barH) + '" width="' + (barW - 2) + '" height="' + barH + '" rx="1.5" fill="' + color + '" opacity="0.6"/>';
  }
  return '<svg width="' + w + '" height="' + h + '" viewBox="0 0 ' + w + ' ' + h + '" preserveAspectRatio="none">' + bars + '</svg>';
}

function getDailySparkData(trends, days) {
  days = days || 14;
  const data = [];
  const today = new Date();
  for (let i = days - 1; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const key = d.toISOString().slice(0, 10);
    data.push(trends[key] || 0);
  }
  return data;
}

/* --- Main View --- */

async function fetchAndRenderMain() {
  try {
    const resp = await fetch('/api/metrics');
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();

    document.getElementById('server-status').textContent = 'online';
    document.getElementById('server-status').className = 'status-pill';
    document.getElementById('version-text').textContent = 'v' + data.server.version;
    document.getElementById('updated-text').textContent = 'Updated ' + new Date().toLocaleTimeString();
    document.getElementById('error-banner').style.display = 'none';

    const grid = document.getElementById('instance-grid');
    grid.innerHTML = '';
    const instances = Object.entries(data.instances);

    instances.forEach(function(entry, idx) {
      const name = entry[0];
      const info = entry[1];
      const calls = data.mcp_calls[name] || { total_calls: 0 };
      const color = COLORS[idx % COLORS.length];
      instanceColorMap[name] = color;
      const status = statusClass(info.latest_file);
      const trends = (data.daily_trends && data.daily_trends[name]) ? data.daily_trends[name] : {};
      const sparkData = getDailySparkData(trends, 14);

      const card = document.createElement('div');
      card.className = 'instance-card';
      card.setAttribute('data-color', color);
      card.onclick = function() { showDetail(name); };

      card.innerHTML = '<div class="card-top">' +
        '<span class="card-name">' + displayName(name) + '</span>' +
        '<span class="card-status ' + status + '"></span>' +
        '</div>' +
        '<div class="card-metric">' +
        '<div class="card-metric-value">' + formatBytes(info.data_size_bytes || 0) + '</div>' +
        '<div class="card-metric-label">Data stored</div>' +
        '</div>' +
        '<div class="card-stats">' +
        '<div><div class="card-stat-value">' + formatNumber(info.ocr_files) + '</div><div class="card-stat-label">Screenshots</div></div>' +
        '<div><div class="card-stat-value">' + formatNumber(calls.total_calls) + '</div><div class="card-stat-label">MCP Calls</div></div>' +
        '<div><div class="card-stat-value">' + timeAgo(info.latest_file) + '</div><div class="card-stat-label">Last Data</div></div>' +
        '</div>' +
        '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">' +
        '<div class="card-sparkline">' + sparklineSVG(sparkData, COLOR_HEX[color]) + '</div>' +
        trendBadge(sparkData) +
        '</div>' +
        '<span class="card-arrow">&#8594;</span>';

      grid.appendChild(card);
    });
  } catch (e) {
    document.getElementById('server-status').textContent = 'offline';
    document.getElementById('server-status').className = 'status-pill offline';
    document.getElementById('error-banner').textContent = 'Failed to fetch metrics: ' + e.message;
    document.getElementById('error-banner').style.display = 'block';
  }
}

/* --- Detail View --- */

async function showDetail(name) {
  currentView = 'detail';
  currentInstance = name;
  document.getElementById('main-view').style.display = 'none';
  document.getElementById('detail-view').style.display = 'block';
  document.getElementById('detail-name').textContent = displayName(name);
  location.hash = '/instance/' + name;

  // Show loading state
  document.getElementById('detail-stats').innerHTML =
    '<div class="stat-card"><div class="loading-skeleton" style="height:40px;width:80px;margin:0 auto;"></div><div class="stat-card-label">loading...</div></div>'.repeat(4);

  try {
    const resp = await fetch('/api/instance/' + encodeURIComponent(name) + '/detail');
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const d = await resp.json();
    const color = instanceColorMap[name] || 'indigo';
    const hex = COLOR_HEX[color] || COLOR_HEX.indigo;

    document.getElementById('detail-status').textContent = 'online';
    document.getElementById('detail-status').className = 'status-pill';

    // Stats row
    var avgMs = d.latency ? d.latency.avg_ms : 0;
    document.getElementById('detail-stats').innerHTML =
      '<div class="stat-card"><div class="stat-card-value">' + formatBytes(d.data.size_bytes) + '</div><div class="stat-card-label">Data Stored</div></div>' +
      '<div class="stat-card"><div class="stat-card-value">' + formatNumber(d.data.file_count) + '</div><div class="stat-card-label">Screenshots</div></div>' +
      '<div class="stat-card"><div class="stat-card-value">' + formatNumber(d.usage.total_calls) + '</div><div class="stat-card-label">MCP Calls</div></div>' +
      '<div class="stat-card"><div class="stat-card-value">' + (avgMs ? avgMs + 'ms' : '&#8212;') + '</div><div class="stat-card-label">Avg Latency</div></div>';

    // Usage chart
    var daily = d.usage.daily || [];
    var chart = document.getElementById('usage-chart');
    if (daily.length === 0) {
      chart.innerHTML = '<span style="color:#3a3a54;font-size:12px;">No usage data yet</span>';
    } else {
      var maxCalls = Math.max.apply(null, daily.map(function(r) { return r.calls; }).concat([1]));
      chart.innerHTML = daily.map(function(r) {
        var pct = (r.calls / maxCalls) * 100;
        var label = r.date.slice(5);
        return '<div class="chart-bar-wrapper" title="' + r.date + ': ' + r.calls + ' calls">' +
          '<div class="chart-tooltip">' + r.calls + '</div>' +
          '<div class="chart-bar" style="height:' + Math.max(pct, 2) + '%;background:' + hex + '"></div>' +
          '<span class="chart-label">' + label + '</span></div>';
      }).join('');
    }

    // Tool breakdown
    var tools = Object.entries(d.usage.by_tool || {});
    var toolDiv = document.getElementById('tool-breakdown');
    if (tools.length === 0) {
      toolDiv.innerHTML = '<span style="color:#3a3a54;font-size:12px;">No tool data yet</span>';
    } else {
      var maxToolCalls = tools[0][1];
      toolDiv.innerHTML = tools.map(function(entry) {
        var tool = entry[0], count = entry[1];
        var pct = (count / maxToolCalls) * 100;
        return '<div class="tool-row">' +
          '<span class="tool-name" title="' + tool + '">' + tool + '</span>' +
          '<div class="tool-bar-bg"><div class="tool-bar-fill" style="width:' + Math.max(pct, 2) + '%;background:' + hex + '"></div></div>' +
          '<span class="tool-count">' + count + '</span></div>';
      }).join('');
    }

    // Data info
    document.getElementById('data-info').innerHTML =
      '<div class="data-item"><div class="data-item-label">Oldest Record</div><div class="data-item-value">' +
      (d.data.oldest ? new Date(d.data.oldest).toLocaleDateString() : '&#8212;') + '</div></div>' +
      '<div class="data-item"><div class="data-item-label">Newest Record</div><div class="data-item-value">' +
      (d.data.newest ? timeAgo(d.data.newest) : '&#8212;') + '</div></div>' +
      '<div class="data-item"><div class="data-item-label">Avg File Size</div><div class="data-item-value">' +
      (d.data.file_count > 0 ? formatBytes(d.data.size_bytes / d.data.file_count) : '&#8212;') + '</div></div>' +
      '<div class="data-item"><div class="data-item-label">P95 Latency</div><div class="data-item-value">' +
      (d.latency && d.latency.p95_ms ? d.latency.p95_ms + 'ms' : '&#8212;') + '</div></div>';

  } catch (e) {
    document.getElementById('detail-stats').innerHTML =
      '<div class="stat-card" style="grid-column:1/-1;color:#f87171;">Error loading details: ' + e.message + '</div>';
  }
}

function showMain() {
  currentView = 'main';
  currentInstance = null;
  document.getElementById('main-view').style.display = 'block';
  document.getElementById('detail-view').style.display = 'none';
  location.hash = '';
  fetchAndRenderMain();
}

/* --- Routing --- */

function handleRoute() {
  var hash = location.hash;
  var match = hash.match(/^#\/instance\/(.+)$/);
  if (match) {
    showDetail(decodeURIComponent(match[1]));
  } else {
    currentView = 'main';
    document.getElementById('main-view').style.display = 'block';
    document.getElementById('detail-view').style.display = 'none';
    fetchAndRenderMain();
  }
}

/* --- Timer --- */

function refresh() {
  if (currentView === 'main') {
    fetchAndRenderMain();
  } else if (currentView === 'detail' && currentInstance) {
    showDetail(currentInstance);
  }
}

function startTimer() {
  countdown = REFRESH_MS / 1000;
  clearInterval(timerInterval);
  timerInterval = setInterval(function() {
    countdown--;
    document.getElementById('refresh-timer').textContent = 'refresh ' + countdown + 's';
    if (countdown <= 0) {
      refresh();
      countdown = REFRESH_MS / 1000;
    }
  }, 1000);
}

/* --- Chat --- */

var chatInstance = null;
var chatCrossInstance = false;
var chatSessionIds = {};  // per-instance session IDs
var chatStreaming = false;

function getChatSessionKey() {
  return chatCrossInstance ? '_cross_' : chatInstance;
}

function openChat(instance, crossInstance) {
  chatInstance = instance;
  chatCrossInstance = crossInstance;
  var title = crossInstance ? 'Chat — All Instances' : 'Chat — ' + displayName(instance || '');
  document.getElementById('chat-title').textContent = title;
  document.getElementById('chat-overlay').classList.add('open');
  document.getElementById('chat-input').focus();

  // Restore messages from DOM cache if same session
  var key = getChatSessionKey();
  if (!document.getElementById('chat-messages').dataset.sessionKey ||
      document.getElementById('chat-messages').dataset.sessionKey !== key) {
    document.getElementById('chat-messages').innerHTML = '';
    document.getElementById('chat-messages').dataset.sessionKey = key;
  }
}

function closeChat() {
  document.getElementById('chat-overlay').classList.remove('open');
}

function appendChatMsg(role, html) {
  var msgDiv = document.createElement('div');
  msgDiv.className = 'chat-msg ' + role;
  msgDiv.innerHTML = html;
  document.getElementById('chat-messages').appendChild(msgDiv);
  scrollChatBottom();
  return msgDiv;
}

function appendToolIndicator(name) {
  var div = document.createElement('div');
  div.className = 'chat-tool-indicator';
  div.innerHTML = '&#9881; ' + name + '...';
  div.onclick = function() { div.classList.toggle('expanded'); };
  document.getElementById('chat-messages').appendChild(div);
  scrollChatBottom();
  return div;
}

function appendPageCard(title, url) {
  var div = document.createElement('div');
  div.className = 'chat-page-card';
  div.innerHTML = '<div class="chat-page-card-title">' + escapeHtml(title) + '</div>' +
                  '<div class="chat-page-card-url">' + url + '</div>';
  div.onclick = function() { window.open(url, '_blank'); };
  document.getElementById('chat-messages').appendChild(div);
  scrollChatBottom();
}

function scrollChatBottom() {
  var el = document.getElementById('chat-messages');
  el.scrollTop = el.scrollHeight;
}

function escapeHtml(str) {
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// Simple markdown rendering
function renderMd(text) {
  // Code blocks
  text = text.replace(/```(\w*)\n([\s\S]*?)```/g, function(m, lang, code) {
    return '<pre><code>' + escapeHtml(code.trim()) + '</code></pre>';
  });
  // Inline code
  text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Bold
  text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Italic
  text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Links
  text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
  // Headers
  text = text.replace(/^### (.+)$/gm, '<h4>$1</h4>');
  text = text.replace(/^## (.+)$/gm, '<h3>$1</h3>');
  text = text.replace(/^# (.+)$/gm, '<h2>$1</h2>');
  // Unordered lists
  text = text.replace(/^- (.+)$/gm, '<li>$1</li>');
  text = text.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
  // Paragraphs — split by double newline
  text = text.replace(/\n\n/g, '</p><p>');
  text = '<p>' + text + '</p>';
  text = text.replace(/<p>\s*<(h[234]|ul|pre|ol)/g, '<$1');
  text = text.replace(/<\/(h[234]|ul|pre|ol)>\s*<\/p>/g, '</$1>');
  return text;
}

async function sendChat() {
  if (chatStreaming) return;
  var input = document.getElementById('chat-input');
  var message = input.value.trim();
  if (!message) return;

  input.value = '';
  appendChatMsg('user', escapeHtml(message));

  chatStreaming = true;
  document.getElementById('chat-send').disabled = true;

  var key = getChatSessionKey();
  var sessionId = chatSessionIds[key] || null;
  var url = chatCrossInstance ? '/chat' : '/' + encodeURIComponent(chatInstance) + '/chat';

  try {
    var resp = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ message: message, session_id: sessionId }),
    });

    if (!resp.ok) {
      var errText = await resp.text();
      appendChatMsg('assistant', '<span style="color:#f87171;">Error: ' + resp.status + ' — ' + escapeHtml(errText) + '</span>');
      chatStreaming = false;
      document.getElementById('chat-send').disabled = false;
      return;
    }

    // Read SSE stream
    var reader = resp.body.getReader();
    var decoder = new TextDecoder();
    var buffer = '';
    var currentAssistantMsg = null;
    var currentText = '';

    while (true) {
      var result = await reader.read();
      if (result.done) break;
      buffer += decoder.decode(result.value, { stream: true });

      var lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        if (line.startsWith('event: ')) {
          var eventType = line.slice(7).trim();
          var dataLine = lines[i + 1];
          if (dataLine && dataLine.startsWith('data: ')) {
            var data = dataLine.slice(6);
            i++; // skip data line
            handleSSE(eventType, data);
          }
        }
      }
    }

    // Finalize any in-progress message
    if (currentAssistantMsg && currentText) {
      currentAssistantMsg.innerHTML = renderMd(currentText);
    }

    function handleSSE(type, dataStr) {
      var data;
      try { data = JSON.parse(dataStr); } catch (e) { data = {}; }

      if (type === 'session') {
        chatSessionIds[key] = data.session_id;
      } else if (type === 'text') {
        if (!currentAssistantMsg) {
          currentAssistantMsg = appendChatMsg('assistant', '');
          currentText = '';
        }
        currentText += (data.text || '');
        currentAssistantMsg.innerHTML = renderMd(currentText);
        scrollChatBottom();
      } else if (type === 'tool_call') {
        // Finalize prior text
        if (currentAssistantMsg && currentText) {
          currentAssistantMsg.innerHTML = renderMd(currentText);
          currentAssistantMsg = null;
          currentText = '';
        }
        appendToolIndicator(data.name || 'tool');
      } else if (type === 'tool_result') {
        // Update last tool indicator
        var indicators = document.querySelectorAll('.chat-tool-indicator');
        if (indicators.length > 0) {
          var last = indicators[indicators.length - 1];
          var name = data.name || 'tool';
          last.innerHTML = '&#10003; ' + name + '<div class="chat-tool-detail">' + escapeHtml(data.result_preview || '') + '</div>';
        }
      } else if (type === 'page_created') {
        appendPageCard(data.title || 'Page', data.url || '#');
      } else if (type === 'error') {
        appendChatMsg('assistant', '<span style="color:#f87171;">' + escapeHtml(data.error || 'Unknown error') + '</span>');
      } else if (type === 'done') {
        // Finalize
        if (currentAssistantMsg && currentText) {
          currentAssistantMsg.innerHTML = renderMd(currentText);
        }
        currentAssistantMsg = null;
        currentText = '';
      }
    }

  } catch (e) {
    appendChatMsg('assistant', '<span style="color:#f87171;">Connection error: ' + escapeHtml(e.message) + '</span>');
  }

  chatStreaming = false;
  document.getElementById('chat-send').disabled = false;
}

window.addEventListener('hashchange', handleRoute);
handleRoute();
startTimer();
</script>
</body>
</html>
